name: AOT Build and Package

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  release:
    types: [ created ]

permissions:
  contents: write
  packages: write
  deployments: write

env:
  DOTNET_SDK_VERSION: 9.0.x
  PROJECT_PATH: src/Deck.Console/Deck.Console.csproj
  BUILD_DIR: build/release
  DIST_DIR: dist

jobs:
  aot-build-and-package:
    name: AOT Build and Package (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_SDK_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Validate project structure
      shell: bash
      run: |
        echo "ğŸ” Validating .NET project structure..."
        
        # Check required files one by one
        files=("src/Deck.Console/Deck.Console.csproj" "src/Deck.Console/Program.cs" "src/Deck.Core/Deck.Core.csproj" "src/Deck.Services/Deck.Services.csproj" "scripts/build.sh" "scripts/package.sh" "scripts/package.ps1")
        
        for file in "${files[@]}"; do
          if [[ ! -f "$file" ]]; then
            echo "âŒ Missing required file: $file"
            exit 1
          fi
        done
        
        echo "âœ… Project structure validation passed"

    - name: Set up environment for macOS
      if: runner.os == 'macOS'
      run: |
        # macOS uses system builtin pkgbuild, no additional packages needed
        echo "macOS environment ready - using builtin pkgbuild for PKG creation"

    - name: Set up environment for Linux
      if: runner.os == 'Linux'
      run: |
        # Linux creates TAR.GZ packages, no additional packages needed
        echo "Linux environment ready - using builtin tar for TAR.GZ creation"

    - name: Set up environment for Windows
      if: runner.os == 'Windows'
      run: |
        # Install Microsoft C++ Build Tools and Windows SDK for AOT compilation
        echo "Installing Microsoft C++ Build Tools and Windows SDK..."
        choco install visualstudio2022buildtools --package-parameters '--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --add Microsoft.VisualStudio.Component.Windows11SDK.22000 --add Microsoft.VisualStudio.Component.VC.Redist.14.Latest' -y
        
        # Install WiX Toolset v4 for MSI package creation
        echo "Installing WiX Toolset v4 globally..."
        dotnet tool install --global wix --version 4.0.5
        
        # Refresh PATH to include dotnet tools
        $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PATH","User")
        
        # Verify WiX installation with detailed diagnostics
        echo "Verifying WiX installation..."
        echo "PATH contents:"
        $env:PATH -split ';' | Where-Object { $_ -like "*dotnet*" -or $_ -like "*tools*" } | ForEach-Object { echo "  $_" }
        
        echo "Global .NET tools location:"
        if (Test-Path "$env:USERPROFILE\.dotnet\tools") {
          echo "  $env:USERPROFILE\.dotnet\tools exists"
          Get-ChildItem "$env:USERPROFILE\.dotnet\tools" -Name
        }
        
        echo "Testing WiX command availability:"
        try {
          wix --version
          echo "âœ… WiX command successful"
        } catch {
          echo "âŒ WiX command failed: $_"
          echo "Trying direct path..."
          & "$env:USERPROFILE\.dotnet\tools\wix.exe" --version
        }
        
        # Verify other development tools
        echo "Verifying Windows development environment..."
        where link.exe || echo "Link.exe not found in PATH"
        if (Test-Path "C:\Program Files (x86)\Windows Kits\10\Lib") { echo "Windows SDK found" } else { echo "Windows SDK not found" }
        if (Test-Path "C:\Program Files\Microsoft Visual Studio\2022\BuildTools\VC\Tools\MSVC") { echo "MSVC Build Tools found" } else { echo "MSVC Build Tools not found" }
        echo "Windows environment ready for AOT compilation and MSI packaging"

    - name: AOT Build and Package
      shell: bash
      run: |
        echo "ğŸš€ Building Deck .NET v1.0.0-aot with AOT optimizations..."
        
        # Make scripts executable first
        chmod +x scripts/build.sh scripts/package.sh 2>/dev/null || true
        
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          # Windows PowerShell version - use two-step approach with fallback
          echo "ğŸ“¦ Step 1: Running build script with AOT..."
          if ! pwsh -Command "& '.\scripts\build.ps1' -Version '1.0.0-aot' -Configuration Release -Aot"; then
            echo "âš ï¸  AOT build failed, trying standard build..."
            pwsh -Command "& '.\scripts\build.ps1' -Version '1.0.0-aot' -Configuration Release"
          fi
          
          echo "ğŸ“¦ Step 2: Running package script..." 
          pwsh -Command "& '.\scripts\package.ps1' -Version '1.0.0-aot' -Configuration Release"
        else
          # Unix/Linux/macOS bash version - use two-step approach
          echo "ğŸ“¦ Step 1: Running build script..."
          ./scripts/build.sh --version "1.0.0-aot" --configuration Release --aot
          
          echo "ğŸ“¦ Step 2: Running package script..."
          ./scripts/package.sh --version "1.0.0-aot" --configuration Release
        fi
        
        echo "âœ… Build and packaging completed"

    - name: Verify AOT packages
      shell: bash
      run: |
        # Check if packages were created successfully
        if [ -d "${{ env.DIST_DIR }}" ]; then
          echo "âœ… AOT packages created successfully"
          echo ""
          echo "ğŸ“¦ Created packages:"
          find ${{ env.DIST_DIR }} -type f
          echo ""
          
          # Verify package types by platform
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            PKG_COUNT=$(find ${{ env.DIST_DIR }} -name "*.pkg" | wc -l)
            if [ $PKG_COUNT -gt 0 ]; then
              echo "âœ… macOS PKG packages found: $PKG_COUNT"
              # Verify PKG contents include uninstall script
              for pkg in $(find ${{ env.DIST_DIR }} -name "*.pkg"); do
                echo "ğŸ“‹ Checking PKG contents: $pkg"
                pkgutil --payload-files "$pkg" | grep -q "deck-uninstall" && echo "âœ… Uninstall script included" || echo "âš ï¸  Uninstall script missing"
              done
            else
              echo "âŒ No PKG packages found for macOS"
              exit 1
            fi
            
          elif [[ "$RUNNER_OS" == "Linux" ]]; then
            TAR_COUNT=$(find ${{ env.DIST_DIR }} -name "*.tar.gz" | wc -l)
            if [ $TAR_COUNT -gt 0 ]; then
              echo "âœ… Linux TAR.GZ packages found: $TAR_COUNT"
            else
              echo "âŒ No TAR.GZ packages found for Linux"
              exit 1
            fi
            
          elif [[ "$RUNNER_OS" == "Windows" ]]; then
            MSI_COUNT=$(find ${{ env.DIST_DIR }} -name "*.msi" | wc -l)
            if [ $MSI_COUNT -gt 0 ]; then
              echo "âœ… Windows MSI packages found: $MSI_COUNT"
            else
              # Fallback to check for ZIP if MSI creation failed
              ZIP_COUNT=$(find ${{ env.DIST_DIR }} -name "*.zip" | wc -l)
              if [ $ZIP_COUNT -gt 0 ]; then
                echo "âš ï¸  MSI creation failed, but ZIP packages found: $ZIP_COUNT"
              else
                echo "âŒ No MSI or ZIP packages found for Windows"
                exit 1
              fi
            fi
          fi
        else
          echo "âŒ AOT packaging failed - no packages found"
          exit 1
        fi

    - name: Test packages
      shell: bash
      run: |
        echo "ğŸ§ª Testing generated packages..."
        
        if [[ "$RUNNER_OS" == "macOS" ]]; then
          # Test macOS PKG (can't install without sudo, but can check structure)
          for pkg in $(find ${{ env.DIST_DIR }} -name "*.pkg" 2>/dev/null || true); do
            if [[ -f "$pkg" ]]; then
              echo "ğŸ“‹ Testing PKG structure: $pkg"
              pkgutil --payload-files "$pkg" | head -10
              echo "âœ… PKG structure test passed"
              break
            fi
          done
        elif [[ "$RUNNER_OS" == "Linux" ]]; then
          # Test Linux TAR.GZ
          for tarfile in $(find ${{ env.DIST_DIR }} -name "*.tar.gz" 2>/dev/null || true); do
            if [[ -f "$tarfile" ]]; then
              echo "ğŸ“‹ Testing TAR.GZ: $tarfile"
              cd $(dirname "$tarfile")
              tar -tzf $(basename "$tarfile") | head -10
              echo "âœ… TAR.GZ structure test passed"
              break
            fi
          done
        elif [[ "$RUNNER_OS" == "Windows" ]]; then
          # Test Windows MSI first, then ZIP fallback
          MSI_FOUND=false
          for msifile in $(find ${{ env.DIST_DIR }} -name "*.msi" 2>/dev/null || true); do
            if [[ -f "$msifile" ]]; then
              echo "ğŸ“‹ Testing MSI: $msifile"
              # Use PowerShell to check MSI properties on Windows
              pwsh -Command "Get-ItemProperty '$msifile' | Select-Object Name, Length, LastWriteTime"
              echo "âœ… MSI structure test passed"
              MSI_FOUND=true
              break
            fi
          done
          
          if [[ "$MSI_FOUND" == "false" ]]; then
            # Fallback to ZIP testing
            for zipfile in $(find ${{ env.DIST_DIR }} -name "*.zip" 2>/dev/null || true); do
              if [[ -f "$zipfile" ]]; then
                echo "ğŸ“‹ Testing ZIP fallback: $zipfile"
                pwsh -Command "Add-Type -AssemblyName System.IO.Compression.FileSystem; [System.IO.Compression.ZipFile]::OpenRead('$zipfile').Entries | Select-Object -First 10 Name"
                echo "âœ… ZIP structure test passed"
                break
              fi
            done
          fi
        fi

    - name: Upload AOT package artifacts
      uses: actions/upload-artifact@v4
      with:
        name: aot-package-${{ runner.os }}
        path: ${{ env.DIST_DIR }}/
        if-no-files-found: error

  release-aot:
    name: Create AOT Release Packages
    needs: aot-build-and-package
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download all AOT package artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./aot-artifacts

    - name: List all AOT artifacts
      run: |
        find ./aot-artifacts -type f

    - name: Upload AOT release assets
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: "Deck .NET ${{ github.ref_name }} - AOT Optimized Release"
        body: |
          ## Deck .NET ${{ github.ref_name }} - AOT Optimized Release
          
          é«˜æ€§èƒ½çš„ .NET AOT ä¼˜åŒ–ç‰ˆæœ¬ï¼ŒåŒ…å«ä»¥ä¸‹å¹³å°çš„é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼š
          
          ### ğŸ“¦ åŒ…å«çš„åŒ…
          - **Windows**: MSI å®‰è£…åŒ… (x64, ARM64)
          - **macOS**: PKG å®‰è£…åŒ… (x64, ARM64)  
          - **Linux**: TAR.GZ å‹ç¼©åŒ… (x64)
          
          ### âš¡ AOT ä¼˜åŒ–ç‰¹æ€§
          - å¯åŠ¨æ—¶é—´æ›´å¿«
          - å†…å­˜å ç”¨æ›´ä½
          - æ— éœ€ .NET Runtime
          - å•æ–‡ä»¶éƒ¨ç½²
          
          ### ğŸš€ å®‰è£…æ–¹å¼
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
          2. Windows: åŒå‡» MSI æ–‡ä»¶å®‰è£…
          3. macOS: åŒå‡» PKG æ–‡ä»¶å®‰è£…
          4. Linux: è§£å‹ TAR.GZ åˆ°ç›®æ ‡ç›®å½•
        files: |
          ./aot-artifacts/aot-package-*/**/*
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}