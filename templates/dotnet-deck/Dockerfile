# =============================================================================
# Deck é¡¹ç›®å¼€å‘çŽ¯å¢ƒ - åŸºäºŽ .NET æ¨¡æ¿
# =============================================================================

# æž„å»ºå‚æ•°
ARG DOCKER_REGISTRY
ARG UBUNTU_VERSION
ARG UBUNTU_NAME
ARG DOTNET_VERSION
ARG DOTNET_VERSION_NAME

# åŸºäºŽ dotnet æ¨¡æ¿é•œåƒ
FROM localhost/dotnet${DOTNET_VERSION_NAME}:${DOTNET_VERSION} as deck-dev

# å®šä¹‰æž„å»ºå‚æ•°
ARG DEPENDENCIES
ARG INSTALL_ANDROID_SUPPORT
ARG INSTALL_WASM_TOOLS
ARG INSTALL_WASM_EXPERIMENTAL
ARG INSTALL_WASI_EXPERIMENTAL
ARG INSTALL_DOTNET_WATCH
ARG INSTALL_DOTNET_FORMAT
ARG INSTALL_DOTNET_EF
ARG INSTALL_DOTNET_OUTDATED
ARG INSTALL_DOTNET_TRACE
ARG INSTALL_DOTNET_SERVE

# å®‰è£…é¢å¤–çš„å¼€å‘å·¥å…·ï¼ˆvimå’Œnanoå·²ç»åœ¨DEPENDENCIESä¸­ï¼‰
RUN apt-get update && apt-get install -y ${DEPENDENCIES} && rm -rf /var/lib/apt/lists/*

# åˆ›å»º Deck å¼€å‘çŽ¯å¢ƒä¿¡æ¯è„šæœ¬
RUN echo '#!/bin/bash' > /usr/local/bin/deck-dev && \
    echo 'echo "ðŸš€ Deck é¡¹ç›®å¼€å‘çŽ¯å¢ƒ"' >> /usr/local/bin/deck-dev && \
    echo 'echo "ðŸ“ Workspace: $(pwd)"' >> /usr/local/bin/deck-dev && \
    echo 'echo "ðŸ”· .NET: $(/usr/share/dotnet/dotnet --version)"' >> /usr/local/bin/deck-dev && \
    echo "" >> /usr/local/bin/deck-dev && \
    echo 'echo "ðŸ“¦ å·²å®‰è£…çš„åŠŸèƒ½:"' >> /usr/local/bin/deck-dev && \
    echo 'if /usr/share/dotnet/dotnet workload list 2>/dev/null | grep -q "android"; then echo "  âœ… Android å·¥ä½œè´Ÿè½½"; else echo "  âŒ Android å·¥ä½œè´Ÿè½½"; fi' >> /usr/local/bin/deck-dev && \
    echo 'if /usr/share/dotnet/dotnet workload list 2>/dev/null | grep -q "wasm-tools"; then echo "  âœ… WebAssembly å·¥å…·"; else echo "  âŒ WebAssembly å·¥å…·"; fi' >> /usr/local/bin/deck-dev && \
    echo 'if command -v dotnet-ef > /dev/null 2>&1; then echo "  âœ… Entity Framework å·¥å…·"; else echo "  âŒ Entity Framework å·¥å…·"; fi' >> /usr/local/bin/deck-dev && \
    echo 'if command -v dotnet-watch > /dev/null 2>&1; then echo "  âœ… ç›‘è§†å·¥å…·"; else echo "  âŒ ç›‘è§†å·¥å…·"; fi' >> /usr/local/bin/deck-dev && \
    echo "" >> /usr/local/bin/deck-dev && \
    echo 'echo "ðŸ”§ æ ¸å¿ƒå‘½ä»¤:"' >> /usr/local/bin/deck-dev && \
    echo 'echo "  dotnet run --project src/Deck.Console    - è¿è¡Œ Deck"' >> /usr/local/bin/deck-dev && \
    echo 'echo "  dotnet build                            - æž„å»ºé¡¹ç›®"' >> /usr/local/bin/deck-dev && \
    echo 'if command -v dotnet-watch > /dev/null 2>&1; then echo "  dotnet watch                            - ç›‘è§†æ–‡ä»¶å˜åŒ–"; fi' >> /usr/local/bin/deck-dev && \
    echo 'echo "  dotnet test                             - è¿è¡Œæµ‹è¯•"' >> /usr/local/bin/deck-dev && \
    echo 'if command -v dotnet-ef > /dev/null 2>&1; then echo "  dotnet ef                               - Entity Framework å‘½ä»¤"; fi' >> /usr/local/bin/deck-dev && \
    echo 'if command -v dotnet-format > /dev/null 2>&1; then echo "  dotnet format                           - æ ¼å¼åŒ–ä»£ç "; fi' >> /usr/local/bin/deck-dev && \
    echo 'if command -v dotnet-outdated-tool > /dev/null 2>&1; then echo "  dotnet outdated                         - æ£€æŸ¥è¿‡æ—¶çš„åŒ…"; fi' >> /usr/local/bin/deck-dev && \
    echo 'if command -v dotnet-trace > /dev/null 2>&1; then echo "  dotnet trace                            - æ”¶é›†è·Ÿè¸ªä¿¡æ¯"; fi' >> /usr/local/bin/deck-dev && \
    echo "" >> /usr/local/bin/deck-dev && \
    echo 'echo "ðŸ–¥ï¸  Deck é¡¹ç›®ç»“æž„:"' >> /usr/local/bin/deck-dev && \
    echo 'echo "  src/Deck.Console        - å‘½ä»¤è¡Œç•Œé¢"' >> /usr/local/bin/deck-dev && \
    echo 'echo "  src/Deck.Core           - æ ¸å¿ƒæŽ¥å£å’Œæ¨¡åž‹"' >> /usr/local/bin/deck-dev && \
    echo 'echo "  src/Deck.Services       - ä¸šåŠ¡æœåŠ¡å®žçŽ°"' >> /usr/local/bin/deck-dev && \
    echo 'echo "  src/Deck.Infrastructure - åŸºç¡€è®¾æ–½å®žçŽ°"' >> /usr/local/bin/deck-dev && \
    echo 'echo "  tests/                  - æµ‹è¯•é¡¹ç›®"' >> /usr/local/bin/deck-dev && \
    echo "" >> /usr/local/bin/deck-dev && \
    echo 'if [ "$#" -eq 0 ]; then' >> /usr/local/bin/deck-dev && \
    echo '  exec bash' >> /usr/local/bin/deck-dev && \
    echo 'else' >> /usr/local/bin/deck-dev && \
    echo '  # æ£€æŸ¥æ˜¯å¦æ˜¯è¦è¿è¡ŒDecké¡¹ç›®' >> /usr/local/bin/deck-dev && \
    echo '  if [ "$1" = "run" ] && [ "$#" -eq 1 ]; then' >> /usr/local/bin/deck-dev && \
    echo '    exec /usr/share/dotnet/dotnet run --project src/Deck.Console' >> /usr/local/bin/deck-dev && \
    echo '  else' >> /usr/local/bin/deck-dev && \
    echo '    # å°†å‚æ•°ä¼ é€’ç»™dotnetå‘½ä»¤' >> /usr/local/bin/deck-dev && \
    echo '    exec /usr/share/dotnet/dotnet "$@"' >> /usr/local/bin/deck-dev && \
    echo '  fi' >> /usr/local/bin/deck-dev && \
    echo 'fi' >> /usr/local/bin/deck-dev && \
    chmod +x /usr/local/bin/deck-dev

WORKDIR /workspace
EXPOSE 5000 9229

CMD ["deck-dev"]